<div class="section section-basic">
  <br />
  <br />
  <div class="container">

    <!-- Título dinâmico -->
    <div id="inputs">
      <h4 *ngIf="!isEdit">Nova Promoção</h4>
      <h4 *ngIf="isEdit">Alterar Promoção</h4>
      <br />

      <!-- Alerts -->
      <div *ngFor="let alert of alerts">
        <ngb-alert [type]="alert.type" [dismissible]="false">
          <div class="container">
            <div class="alert-wrapper">
              <button type="button" name="button" class="close" (click)="closeAlert(alert)">
                <span aria-hidden="true"><i class="now-ui-icons ui-1_simple-remove"></i></span>
              </button>
              <div class="message">
                <ng-container *ngIf="alert.icon">
                  <div class="alert-icon"><i class="now-ui-icons {{alert.icon}}"></i></div>
                </ng-container>
                <strong>{{alert.strong}} </strong>{{ alert.message }}
              </div>
            </div>
          </div>
        </ngb-alert>
      </div>
    </div>

    <div class="autosafe-card">
      <form [formGroup]="form" (ngSubmit)="savePromotion()">
        <div class="row">
          <!-- COL1 -->
          <div class="col-lg-5">

            <div class="form-group">
              <label>Título *</label>
              <input class="form-control" formControlName="title" placeholder="Título" maxlength="80" />
              <small class="text-danger" *ngIf="form.get('title')?.touched && form.get('title')?.hasError('required')">
                Informe o título.
              </small>
              <small class="text-danger" *ngIf="form.get('title')?.hasError('maxlength')">
                Máximo de 80 caracteres.
              </small>
            </div>

            <div class="form-group">
              <label>Descrição *</label>
              <textarea class="form-control" formControlName="description" rows="3" placeholder="Descrição da promoção"></textarea>
              <small class="text-danger" *ngIf="form.get('description')?.touched && form.get('description')?.hasError('required')">
                Informe a descrição.
              </small>
              <small class="text-danger" *ngIf="form.get('description')?.hasError('maxlength')">
                Máximo de 500 caracteres.
              </small>
            </div>

            <div class="form-group">
              <label>Tipo do Botão (CTA) *</label>
              <select class="form-control" formControlName="ctaButtonType">
                <option value="SEE_MORE">VER MAIS</option>
                <option value="BOOK_NOW">RESERVE AGORA</option>
                <option value="CONTACT_US">CONTATE NOS</option>
              </select>
              <small class="text-muted">Valores aceitos pelo backend.</small>
              <small class="text-danger d-block" *ngIf="form.get('ctaButtonType')?.touched && form.get('ctaButtonType')?.hasError('required')">
                Selecione o tipo do botão.
              </small>
            </div>

            <div class="form-group">
              <label>Tipo *</label>
              <select class="form-control" formControlName="type">
                <option value="PROFILE_REDIRECT">Abrir Perfil</option>
                <option value="EXTERNAL_LINK">Link Externo</option>
                <option value="SERVICE_LINK">Abrir Serviço</option>
              </select>
            </div>

            <!-- Condicional: Link externo -->
            <div class="form-group" *ngIf="form.get('type')?.value === 'EXTERNAL_LINK'">
              <label>Link Externo *</label>
              <input class="form-control" formControlName="externalLink" placeholder="https://..." />
              <small class="text-muted">Use o formato completo com http(s).</small>
              <small class="text-danger d-block" *ngIf="form.get('externalLink')?.touched && form.get('externalLink')?.hasError('required')">
                O link é obrigatório para esse tipo.
              </small>
              <small class="text-danger d-block" *ngIf="form.get('externalLink')?.hasError('pattern')">
                URL inválida. Ex.: https://minha-loja.com
              </small>
            </div>

            <!-- Condicional: Serviço -->
            <div class="form-group" *ngIf="form.get('type')?.value === 'SERVICE_LINK'">
              <label>Selecionar Serviço *</label>
              <input
                class="form-control"
                [value]="serviceQuery"
                (input)="searchServices($any($event.target).value)"
                placeholder="Pesquisar serviço..."
              />
              <div class="list-group mt-1" *ngIf="serviceOptions.length || searching" style="max-height: 220px; overflow-y:auto;">
                <div class="list-group-item" *ngIf="searching">Buscando...</div>
                <button type="button" class="list-group-item list-group-item-action"
                        *ngFor="let s of serviceOptions" (click)="pickService(s)">
                  {{ s.title }}
                </button>
              </div>
              <input type="number" formControlName="serviceId" hidden />
              <div class="mt-2" *ngIf="form.get('serviceId')?.value">
                <span class="badge badge-pill badge-info p-2">
                  Serviço selecionado: {{ serviceQuery }}
                </span>
                <button type="button" class="btn btn-link btn-sm" (click)="form.get('serviceId')!.setValue(null); serviceQuery = ''">
                  limpar
                </button>
              </div>
              <small class="text-danger d-block" *ngIf="form.get('serviceId')?.touched && form.get('serviceId')?.hasError('required')">
                Selecione um serviço.
              </small>
            </div>

            <div class="form-row">
              <div class="form-group col">
                <label>Data Início *</label>
                <input type="date" class="form-control" formControlName="startDate" />
                <small class="text-danger" *ngIf="form.get('startDate')?.touched && form.get('startDate')?.hasError('required')">
                  Informe a data de início.
                </small>
              </div>
              <div class="form-group col">
                <label>Data Fim *</label>
                <input type="date" class="form-control" formControlName="endDate" />
                <small class="text-danger" *ngIf="form.get('endDate')?.touched && form.get('endDate')?.hasError('required')">
                  Informe a data de fim.
                </small>
              </div>
            </div>

            <!-- Erros de faixa de data -->
            <div *ngIf="form.errors?.endBeforeStart" class="text-danger font-weight-bold mt-1">Data fim não pode ser antes do início.</div>
            <div *ngIf="form.errors?.rangeMax30" class="text-danger font-weight-bold mt-1">Promoção pode durar no máximo 30 dias.</div>
            <div *ngIf="form.errors?.startInPast" class="text-danger font-weight-bold mt-1">A data de início deve ser hoje ou futura.</div>
            <div *ngIf="form.errors?.endNotFuture" class="text-danger font-weight-bold mt-1">A data de fim deve ser futura.</div>

            <div class="form-group">
              <label>Imagem *</label>
              <input type="file" class="form-control" accept="image/png,image/jpeg" (change)="onFileChange($event)" />
              <small class="text-muted d-block">PNG ou JPG até 5MB</small>
              <small class="text-muted d-block">Tamanho recomendado: <strong>3:4</strong> — <strong>709 × 945 px</strong></small>
              <small class="text-info d-block" *ngIf="selectedFile">Arquivo selecionado: {{ selectedFile?.name }}</small>
              <small class="text-info d-block" *ngIf="!selectedFile && existingImageUrl">Arquivo atual: {{ fileNameFromUrl(existingImageUrl) }}</small>
              <small class="text-danger d-block" *ngIf="form.get('imageFile')?.touched && form.get('imageFile')?.hasError('required')">
                Selecione uma imagem.
              </small>
            </div>
          </div>

          <!-- COL2: Pré-visualização -->
          <div class="col-lg-4">
            <h4>Pré-visualização</h4>
            <div class="autosafe-card-promotion" style="position:relative;">
              <img *ngIf="previewUrl; else existing" [src]="previewUrl" alt="Prévia"
                   style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover; border-radius:12px;" />
              <ng-template #existing>
                <img *ngIf="existingImageUrl" [src]="existingImageUrl" alt="Imagem atual"
                     style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover; border-radius:12px;" />
                <div *ngIf="!existingImageUrl"
                     style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#bbb;">
                  Sem imagem
                </div>
              </ng-template>

              <div style="position:absolute; inset:0; display:flex; flex-direction:column; justify-content:flex-end;
                          padding:16px; background:linear-gradient(to top, rgba(0,0,0,.45), rgba(0,0,0,0) 40%);">
                <p style="color:#fff; margin:0 0 8px 0; font-weight:700;">
                  {{ form.value.title || 'Título' }}
                </p>
                <button class="btn btn-primary btn-sm" type="button">
                  {{ labelForCta(form.value.ctaButtonType) }}
                </button>
              </div>
            </div>
          </div>

          <!-- COL3: Ação -->
          <div class="col-lg-3 d-flex align-items-end">
            <div class="ml-auto mr-auto w-100 text-center">
              <button class="btn btn-success btn-round btn-lg" type="submit" [disabled]="saving">
                <span *ngIf="saving" class="spinner-border spinner-border-sm mr-1" role="status" aria-hidden="true"></span>
                <i class="now-ui-icons ui-1_check" *ngIf="!saving"></i>
                {{ isEdit ? 'Atualizar Promoção' : 'Salvar Promoção' }}
              </button>
            </div>
          </div>

        </div>
      </form>
    </div>

  </div>
</div>
